# DEP-002 影响面分析功能 - 生产环境测试指南

## 功能概述

DEP-002 影响面分析功能允许您查找某个符号（函数、类、变量等）在项目中的所有引用位置，支持跨文件引用查找。

### 核心能力

- ✅ **符号定义查找** - 跳转到符号定义位置（F12）
- ✅ **引用查找** - 查找所有使用该符号的位置（Shift+F12）
- ✅ **跨文件引用** - 自动识别其他文件中的引用
- ✅ **多语言支持** - TypeScript、JavaScript、Python、Rust、Go 等 20+ 种语言

## 生产环境测试步骤

### 1. 启动应用

```bash
# 开发模式
npm run dev

# 或者构建后运行
npm run build
npm run start
```

### 2. 打开测试项目

1. 点击资源管理器中的 `Add Folder`
2. 选择一个包含多个文件的 TypeScript/JavaScript 项目
3. 建议使用以下测试项目结构：

```
test-project/
├── api.ts          # 定义 API 函数
├── checkout.ts     # 使用 API
├── user-service.ts # 使用 API
└── util.ts         # 工具函数
```

### 3. 测试场景

#### 场景 1: 函数引用查找

**测试文件：`api.ts`**
```typescript
export function calculatePrice(basePrice: number, taxRate: number): number {
  return basePrice * (1 + taxRate);
}

export function formatPrice(price: number): string {
  return "$" + price.toFixed(2);
}
```

**测试文件：`checkout.ts`**
```typescript
import { calculatePrice, formatPrice } from "./api";

export function processCheckout(itemPrice: number) {
  const price = calculatePrice(itemPrice, 0.1);
  return formatPrice(price);
}
```

**测试步骤：**

1. 打开 `api.ts` 文件
2. 将光标放在 `calculatePrice` 函数名上
3. 按下 `Shift+F12`（查找所有引用）
4. 验证：
   - ✅ 显示引用面板
   - ✅ 列出 `calculatePrice` 的定义位置
   - ✅ 列出 `checkout.ts` 中的引用
   - ✅ 点击引用可以跳转到对应位置

#### 场景 2: 类引用查找

**测试文件：`models.ts`**
```typescript
export class User {
  id: number;
  name: string;
  email: string;

  constructor(id: number, name: string, email: string) {
    this.id = id;
    this.name = name;
    this.email = email;
  }

  getDisplayName(): string {
    return this.name;
  }
}
```

**测试文件：`user-service.ts`**
```typescript
import { User } from "./models";

export class UserService {
  getUserName(user: User): string {
    return user.name;
  }
}
```

**测试步骤：**

1. 打开 `models.ts` 文件
2. 将光标放在 `User` 类名上
3. 按下 `Shift+F12`
4. 验证：
   - ✅ 显示 `User` 类的定义位置
   - ✅ 显示 `user-service.ts` 中的引用
   - ✅ 显示 import 语句中的引用

#### 场景 3: 跨模块引用查找

**测试文件：`util.ts`**
```typescript
export function helper(value: string): string {
  return value.toUpperCase();
}
```

**测试文件：`moduleA.ts`**
```typescript
import { helper } from "./util";

export function processA(input: string): string {
  return helper(input);
}
```

**测试文件：`moduleB.ts`**
```typescript
import { helper } from "./util";

export function processB(input: string): string {
  return "B: " + helper(input);
}
```

**测试步骤：**

1. 打开 `util.ts` 文件
2. 将光标放在 `helper` 函数名上
3. 按下 `Shift+F12`
4. 验证：
   - ✅ 找到 `util.ts` 中的定义
   - ✅ 找到 `moduleA.ts` 中的引用
   - ✅ 找到 `moduleB.ts` 中的引用
   - ✅ 总共显示 3 个位置（1 个定义 + 2 个引用）

### 4. 快捷键参考

| 功能 | 快捷键 | 说明 |
|------|--------|------|
| 跳转到定义 | `F12` | 跳转到符号定义位置 |
| 查找所有引用 | `Shift+F12` | 查找符号的所有引用 |
| 打开快捷键帮助 | `Cmd+/` 或 `Ctrl+/` | 查看所有快捷键 |

### 5. 验证清单

#### 基础功能
- [ ] 可以打开包含多个文件的项目
- [ ] 符号索引器正确初始化
- [ ] `Shift+F12` 可以触发引用查找

#### 单文件测试
- [ ] 在同一文件中查找函数引用
- [ ] 在同一文件中查找类引用
- [ ] 在同一文件中查找变量引用

#### 跨文件测试
- [ ] 可以找到其他文件中的引用
- [ ] 可以跳转到其他文件的引用位置
- [ ] 正确处理 import 语句

#### 性能测试
- [ ] 小型项目（<10 文件）响应快速（<1秒）
- [ ] 中型项目（10-50 文件）响应合理（<3秒）
- [ ] 大型项目（>50 文件）可用（<5秒）

### 6. 调试方法

#### 查看控制台日志

打开浏览器开发者工具（F12），查看以下日志：

```javascript
// 符号索引日志
[SymbolIndexer] Indexed /path/to/file.ts: 5 symbols

// 引用查找日志
[ReferencesProvider] Looking for references: calculatePrice
[ReferencesProvider] Found 3 references for: calculatePrice
```

#### 验证符号索引

在浏览器控制台中运行：

```javascript
// 检查符号索引器是否存在
window.__symbolIndexer

// 查看索引统计
window.__symbolIndexer.getStats()

// 手动查找引用
window.__symbolIndexer.findReferences('yourSymbolName')
```

### 7. 常见问题

#### Q1: 按下 Shift+F12 没有反应

**可能原因：**
1. 光标没有放在符号上
2. 文件语言不支持
3. 符号索引器未初始化

**解决方法：**
1. 确保光标在函数名、类名或变量名上
2. 检查文件是否是支持的语言（TypeScript、JavaScript 等）
3. 刷新页面重新加载项目

#### Q2: 只找到当前文件中的引用

**可能原因：**
- 其他文件没有被索引
- 文件内容缓存不完整

**解决方法：**
1. 重新打开相关文件
2. 确保文件被正确保存
3. 检查控制台是否有错误日志

#### Q3: 找到的引用不完整

**可能原因：**
- 符号索引器的简化实现
- 动态生成的代码无法识别

**解决方法：**
1. 这是社区版的已知限制
2. 商业版提供更完整的符号分析

### 8. 测试报告模板

```markdown
## DEP-002 影响面分析测试报告

**测试日期：** YYYY-MM-DD
**测试人员：** [姓名]
**项目版本：** vX.X.X

### 测试环境
- 操作系统: [macOS/Windows/Linux]
- Node.js 版本: [版本号]
- 浏览器: [Chrome/Edge]

### 测试结果

| 测试场景 | 状态 | 备注 |
|---------|------|------|
| 函数引用查找 | ✅/❌ | |
| 类引用查找 | ✅/❌ | |
| 跨文件引用 | ✅/❌ | |
| 性能测试 | ✅/❌ | |

### 发现的问题
1. [问题描述]
2. [问题描述]

### 建议
- [改进建议]
```

## 下一步

完成生产环境测试后，您可以：

1. **反馈问题** - 在 GitHub Issues 中报告发现的问题
2. **查看商业版** - 了解更完整的符号分析功能
3. **参与开发** - 贡献代码改进功能

---

**相关文档：**
- [E2E 测试规范](../../tests/e2e/v0.3.0/impact_analysis.spec.ts)
- [SymbolIndexer 实现](../../src/core/indexer/SymbolIndexer.ts)
- [ReferencesProvider 实现](../../src/components/Editor/ReferencesProvider.ts)
